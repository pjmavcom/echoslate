<UserControl x:Class="Echoslate.UserControls.TodoDisplayView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:b="http://schemas.microsoft.com/xaml/behaviors" xmlns:behaviors="clr-namespace:Echoslate.Behaviors"
             xmlns:converters="clr-namespace:Echoslate.Converters" xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:global="clr-namespace:" xmlns:local="clr-namespace:Echoslate.UserControls"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:resources="clr-namespace:Echoslate.Resources"
             xmlns:todoList="clr-namespace:Echoslate" xmlns:viewModels="clr-namespace:Echoslate.ViewModels"
             d:DesignHeight="500" d:DesignWidth="1400"
             IsVisibleChanged="TodoListView_IsVisibleChanged"
             mc:Ignorable="d">
    <UserControl.Resources>
        <converters:SeverityToBrushConverter x:Key="SeverityToBrushConverter" />
        <converters:BoolToLimeBrushConverter x:Key="BoolToLimeBrushConverter" />
        <converters:BoolToTimerTextConverter x:Key="BoolToTimerTextConverter" />
        <converters:IsTagSelectedConverter x:Key="IsTagSelectedConverter" />
    </UserControl.Resources>
    <UserControl.InputBindings>
        <KeyBinding Key="Enter" Command="{Binding NewTodoAddCommand}" />
        <KeyBinding Key="Enter"
                    Command="{Binding AddAndCompleteCommand}"
                    Modifiers="Control" />
        <!-- <KeyBinding Key="Enter" Command="{StaticResource Edit}" /> -->
        <!--  <KeyBinding Key="Divide"  -->
        <!--  Command="{StaticResource SwitchTab}"  -->
        <!--  CommandParameter="left" />  -->
        <!--  <KeyBinding Key="Multiply"  -->
        <!--  Command="{StaticResource SwitchTab}"  -->
        <!--  CommandParameter="right" />  -->
        <!--  <KeyBinding Key="Subtract"  -->
        <!--  Command="{StaticResource SwitchSeverity}"  -->
        <!--  CommandParameter="up" />  -->
        <!--  <KeyBinding Key="Add"  -->
        <!--  Command="{StaticResource SwitchSeverity}"  -->
        <!--  CommandParameter="down" />  -->
        <!--  <KeyBinding Key="S"  -->
        <!--  Command="{StaticResource QuickSave}"  -->
        <!--  Modifiers="Control" />  -->
        <!--  <KeyBinding Key="OemComma"  -->
        <!--  Command="{StaticResource QuickLoadPrevious}"  -->
        <!--  Modifiers="Control" />  -->
        <!--  <KeyBinding Key="P"  -->
        <!--  Command="{StaticResource StartStopTimer}"  -->
        <!--  Modifiers="Control" />  -->
    </UserControl.InputBindings>
    <Grid Background="{StaticResource AppDarkBackground}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="7*" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!--  Filter button bar  -->
        <Grid Grid.Row="0" Background="{StaticResource AppDarkBackground}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <Button Grid.Column="0"
                    Width="Auto"
                    Background="{Binding CurrentSeverityBrush}"
                    Command="{Binding CycleSeverityFilterCommand}"
                    Content="Severity"
                    Style="{StaticResource SeverityButton}">
            </Button>
            <ItemsControl Grid.Column="1"
                          Margin="10,10,10,5"
                          ItemsSource="{Binding FilterButtons}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel MinWidth="100" Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button Command="{Binding DataContext.SelectTagCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}"
                                Content="{Binding DisplayTitle}">
                            <Button.Style>
                                <Style BasedOn="{StaticResource FilterButton}" TargetType="Button">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#5A5A5A" />
                                        </Trigger>
                                        <DataTrigger Value="True">
                                            <DataTrigger.Binding>
                                                <MultiBinding Converter="{StaticResource IsTagSelectedConverter}">
                                                    <Binding Path="." />
                                                    <Binding Path="DataContext.CurrentFilter" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                </MultiBinding>
                                            </DataTrigger.Binding>
                                            <Setter Property="Background" Value="#0078D7" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
                <ItemsControl.ContextMenu>
                    <ContextMenu>
                        <MenuItem Command="{Binding EditFilterBarCommand}" Header="Edit filters..." />
                    </ContextMenu>
                </ItemsControl.ContextMenu>
            </ItemsControl>
        </Grid>

        <!--  Items NotesPanel  -->
        <local:ItemNotesPanel x:Name="itemNotesPanel"
                              Grid.Row="0" Grid.RowSpan="4"
                              Grid.Column="1"
                              NotesPanelCompleteRequested="NotesPanelCompleteRequested" NotesPanelEditTagsRequested="NotesPanelEditTagsRequested"
                              SelectedTodoItem="{Binding DataContext.SelectedTodoItem, RelativeSource={RelativeSource AncestorType=UserControl}, Mode=OneWay}" />

        <!--  Sorting options row  -->
        <StackPanel Grid.Row="1" Grid.Column="0"
                    Margin="7,0,0,0"
                    Background="{StaticResource AppDarkBackground}"
                    Orientation="Horizontal">
            <ComboBox Width="306"
                      ItemsSource="{Binding CurrentVisibleTags}"
                      KeyboardNavigation.IsTabStop="False" MaxDropDownHeight="360"
                      SelectedItem="{Binding PrioritySortTag, UpdateSourceTrigger=PropertyChanged}" />
            <Button Width="170"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="date" Content="Date"
                    KeyboardNavigation.IsTabStop="False" />
            <Button Width="100"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="severity" Content="Severity"
                    KeyboardNavigation.IsTabStop="False" />
            <Button Width="110"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="rank" Content="Rank"
                    KeyboardNavigation.IsTabStop="False" />
            <Button Width="110"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="active" Content="Active"
                    KeyboardNavigation.IsTabStop="False" />
            <Button Width="200"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="title" Content="Title"
                    KeyboardNavigation.IsTabStop="False" />
        </StackPanel>

        <!--  Main TodoList view  -->
        <!--  x:Name="lbTodos"  -->
        <Border Grid.Row="2" Grid.Column="0"
                Margin="8,4"
                Background="#1E1E1E" CornerRadius="7">
            <Grid>
                <Border BorderBrush="#999999" BorderThickness="7,7,0,0"
                        CornerRadius="7" />
                <Border Margin="-1"
                        BorderBrush="#494949" BorderThickness="0,0,7,7"
                        CornerRadius="7" IsHitTestVisible="False" />
                <ListBox Margin="0" Padding="7,4"
                         HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch"
                         ItemsSource="{Binding DisplayedItems}"
                         KeyboardNavigation.TabIndex="0" ScrollViewer.HorizontalScrollBarVisibility="Hidden"
                         SelectedItem="{Binding SelectedTodoItem, Mode=TwoWay}"
                         SelectionMode="Extended">
                    <b:Interaction.Behaviors>
                        <!--  This syncs selection to the ViewModel automatically  -->
                        <behaviors:SelectedItemsBehavior SelectedItems="{Binding DataContext.SelectedTodoItems, RelativeSource={RelativeSource AncestorType=ListBox}, Mode=OneWay}" />
                    </b:Interaction.Behaviors>
                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Command="{Binding ContextMenuEditCommand}" Header="Edit" />
                            <MenuItem Command="{Binding ContextMenuDeleteCommand}" Header="Delete" />
                            <Separator />
                            <MenuItem Command="{Binding ContextMenuResetTimerCommand}" Header="Reset Timer" />
                            <Separator />
                            <MenuItem Command="{Binding ContextMenuKanban3Command}" Header="Set Kanban: Current" />
                            <MenuItem Command="{Binding ContextMenuKanban2Command}" Header="Set Kanban: Next" />
                            <MenuItem Command="{Binding ContextMenuKanban1Command}" Header="Set Kanban: Backlog" />
                            <MenuItem Command="{Binding ContextMenuKanban0Command}" Header="Set Kanban: None" />
                            <Separator />
                            <MenuItem Command="{Binding ContextMenuMoveToTopCommand}" Header="Move to Top" />
                            <MenuItem Command="{Binding ContextMenuMoveToBottomCommand}" Header="Move to Bottom" />
                            <Separator />
                            <MenuItem Command="{Binding ContextMenuCompleteCommand}" Header="Complete" />
                            <Separator />
                            <MenuItem Command="{Binding DebugPrintTodoCommand}" Header="Debug Print Todo" />
                        </ContextMenu>
                    </ListBox.ContextMenu>
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Height" Value="auto" />
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="Padding" Value="0" />
                            <EventSetter Event="MouseDoubleClick" Handler="ListBoxItem_MouseDoubleClick" />
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid Height="36"
                                  Margin="2"
                                  Background="Transparent"
                                  ToolTip="{Binding NotesAndTags}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="300" />
                                    <ColumnDefinition Width="172" />
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="110" />
                                    <ColumnDefinition Width="110" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0"
                                           Margin="4,0"
                                           Text="{Binding TagsSorted}"
                                           TextTrimming="CharacterEllipsis" TextWrapping="WrapWithOverflow" />
                                <TextBlock Grid.Column="1"
                                           HorizontalAlignment="Center"
                                           FontWeight="Medium" Foreground="#FFFF5555"
                                           Text="{Binding DateTimeStarted}" />
                                <TextBlock Grid.Column="2"
                                           Background="{Binding Severity, Converter={StaticResource SeverityToBrushConverter}}"
                                           FontWeight="SemiBold" Foreground="White"
                                           TextAlignment="Center">
                                    <TextBlock.InputBindings>
                                        <MouseBinding Command="{Binding DataContext.ChangeSeverityCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                      CommandParameter="{Binding}"
                                                      Gesture="LeftClick" />
                                    </TextBlock.InputBindings>
                                </TextBlock>
                                <Grid Grid.Column="3">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="50" />
                                        <ColumnDefinition Width="25" />
                                        <ColumnDefinition Width="25" />
                                    </Grid.ColumnDefinitions>
                                    <Label Grid.Column="0"
                                           HorizontalAlignment="Center"
                                           Content="{Binding Rank}" />
                                    <Button Grid.Column="1"
                                            Command="{Binding DataContext.RankDownCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                            CommandParameter="{Binding}"
                                            Content="▼" FontSize="16"
                                            FontWeight="Bold" />
                                    <Button Grid.Column="2"
                                            Command="{Binding DataContext.RankUpCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                            CommandParameter="{Binding}"
                                            Content="▲" FontSize="16"
                                            FontWeight="Bold" />
                                </Grid>
                                <Label Grid.Column="4"
                                       HorizontalContentAlignment="Center"
                                       Background="{Binding IsTimerOn, Converter={StaticResource BoolToLimeBrushConverter}}"
                                       Content="{Binding TimeTakenDisplay, UpdateSourceTrigger=PropertyChanged}"
                                       Foreground="{Binding IsTimerOn, Converter={StaticResource BoolToTimerTextConverter}}">
                                    <Label.InputBindings>
                                        <MouseBinding Command="{Binding DataContext.ToggleTimerCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                      CommandParameter="{Binding}"
                                                      Gesture="LeftClick" />
                                    </Label.InputBindings>
                                </Label>
                                <TextBlock Grid.Column="5"
                                           Margin="8,0,4,0"
                                           Text="{Binding Todo}"
                                           TextTrimming="CharacterEllipsis" TextWrapping="NoWrap" />
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!--  New TODOItem Editor  -->
        <Grid Grid.Row="3" Grid.Column="0"
              Background="{StaticResource AppDarkBackground}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="270" />
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0"
                    Margin="8,4"
                    Background="#1E1E1E" CornerRadius="7">
                <Grid>
                    <Border BorderBrush="#999999" BorderThickness="7,7,0,0"
                            CornerRadius="7" />
                    <Border Margin="-1"
                            BorderBrush="#494949" BorderThickness="0,0,7,7"
                            CornerRadius="7" IsHitTestVisible="False" />
                    <TextBox Grid.Column="0"
                             Margin="1" Padding="7,4"
                             AcceptsReturn="False" Cursor="IBeam"
                             KeyboardNavigation.TabIndex="1" ScrollViewer.VerticalScrollBarVisibility="Auto"
                             Text="{Binding NewTodoText, UpdateSourceTrigger=PropertyChanged}"
                             TextWrapping="Wrap" />
                </Grid>
            </Border>

            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Button Grid.Column="0"
                        Width="Auto"
                        Background="{Binding NewTodoSeverityBrush}"
                        Command="{Binding CycleNewTodoSeverityCommand}"
                        Content="Severity" Foreground="White"
                        Style="{StaticResource SeverityButton}" />
                <Button Grid.Row="1"
                        Width="Auto"
                        Margin="4,0" Padding="16,8"
                        BorderThickness="0"
                        Command="{Binding NewTodoAddCommand}"
                        Content="Add" KeyboardNavigation.TabIndex="3" />
            </Grid>
        </Grid>
    </Grid>
</UserControl>
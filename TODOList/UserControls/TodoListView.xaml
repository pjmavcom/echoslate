<UserControl x:Class="Echoslate.UserControls.TodoListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:behaviors="clr-namespace:Echoslate.Behaviors" xmlns:converters="clr-namespace:Echoslate.Converters" xmlns:d="http://schemas.microsoft.com/expression/blend/2008" xmlns:global="clr-namespace:" xmlns:local="clr-namespace:Echoslate.UserControls"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:resources="clr-namespace:Echoslate.Resources" xmlns:todoList="clr-namespace:Echoslate" xmlns:viewModels="clr-namespace:Echoslate.ViewModels"
             d:DesignHeight="500" d:DesignWidth="1400" IsVisibleChanged="TodoListView_IsVisibleChanged"
             mc:Ignorable="d"
             >
    <UserControl.Resources>
        <converters:SeverityToBrushConverter x:Key="SeverityToBrushConverter" />
        <converters:BoolToLimeBrushConverter x:Key="BoolToLimeBrushConverter" />
        <converters:BoolToTimerTextConverter x:Key="BoolToTimerTextConverter" />
        <converters:IsTagSelectedConverter x:Key="IsTagSelectedConverter" />
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="7*" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!--  Filter button bar  -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <Button Grid.Column="0"
                    Width="Auto"
                    Background="{Binding CurrentSeverityBrush}"
                    Command="{Binding CycleSeverityFilterCommand}"
                    Content="Severity"
                    Style="{StaticResource SeverityButton}"
                    >
            </Button>
            <ItemsControl Grid.Column="1"
                          Margin="10,10,10,5"
                          ItemsSource="{Binding FilterTags}"
                          >
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel MinWidth="100" Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button Command="{Binding DataContext.SelectTagCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}"
                                Content="{Binding}"
                                >
                            <Button.Style>
                                <Style BasedOn="{StaticResource FilterButton}" TargetType="Button">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#5A5A5A" />
                                        </Trigger>
                                        <DataTrigger Value="True">
                                            <DataTrigger.Binding>
                                                <MultiBinding Converter="{StaticResource IsTagSelectedConverter}">
                                                    <Binding Path="." />
                                                    <Binding Path="DataContext.CurrentTagFilter" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                </MultiBinding>
                                            </DataTrigger.Binding>
                                            <Setter Property="Background" Value="#0078D7" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
                <ItemsControl.ContextMenu>
                    <ContextMenu>
                        <MenuItem Command="{Binding EditFilterBarCommand}" Header="Edit filters..." />
                    </ContextMenu>
                </ItemsControl.ContextMenu>
            </ItemsControl>
        </Grid>

        <!--  Sorting options row  -->
        <StackPanel Grid.Row="1" Grid.Column="0"
                    Orientation="Horizontal"
                    >
            <ComboBox Width="301"
                      ItemsSource="{Binding CurrentVisibleTags}"
                      KeyboardNavigation.IsTabStop="False" MaxDropDownHeight="360"
                      SelectedItem="{Binding PrioritySortTag, UpdateSourceTrigger=PropertyChanged}"
                      />
            <Button Width="161"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="date" Content="Date" KeyboardNavigation.IsTabStop="False"
                    />
            <Button Width="101"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="severity" Content="Severity" KeyboardNavigation.IsTabStop="False"
                    />
            <Button Width="111"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="rank" Content="Rank" KeyboardNavigation.IsTabStop="False"
                    />
            <Button Width="71"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="kanban" Content="Kanban" KeyboardNavigation.IsTabStop="False"
                    />
            <Button Width="111"
                    Command="{Binding DataContext.SelectSortCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                    CommandParameter="active" Content="Active" KeyboardNavigation.IsTabStop="False"
                    />
        </StackPanel>

        <!--  Main TodoList view  -->
        <ListBox x:Name="lbTodos"
                 Grid.Row="2" Grid.Column="0"
                 HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch"
                 ItemsSource="{Binding DisplayedItems}"
                 KeyboardNavigation.TabIndex="0" ScrollViewer.HorizontalScrollBarVisibility="Auto" SelectionMode="Extended"
                 >
            <ListBox.ContextMenu>
                <ContextMenu>
                    <MenuItem Command="{Binding ContextMenuEditCommand}" Header="Edit" />
                    <MenuItem Command="{Binding ContextMenuDeleteCommand}" Header="Delete" />
                    <Separator />
                    <MenuItem Command="{Binding ContextMenuResetTimerCommand}" Header="Reset Timer" />
                    <Separator />
                    <MenuItem Command="{Binding ContextMenuKanban3Command}" Header="Set Kanban: Current" />
                    <MenuItem Command="{Binding ContextMenuKanban2Command}" Header="Set Kanban: Next" />
                    <MenuItem Command="{Binding ContextMenuKanban1Command}" Header="Set Kanban: Backlog" />
                    <MenuItem Command="{Binding ContextMenuKanban0Command}" Header="Set Kanban: None" />
                    <Separator />
                    <MenuItem Command="{Binding ContextMenuMoveToTopCommand}" Header="Move to Top" />
                    <MenuItem Command="{Binding ContextMenuMoveToBottomCommand}" Header="Move to Bottom" />
                    <Separator />
                    <MenuItem Command="{Binding ContextMenuCompleteCommand}" Header="Complete" />
                    <Separator />
                    <MenuItem Command="{Binding DebugPrintTodoCommand}" Header="Debug Print Todo" />
                </ContextMenu>
            </ListBox.ContextMenu>
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="Height" Value="auto" />
                    <Setter Property="Padding" Value="0" />
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid Height="36"
                          Margin="2"
                          Background="Transparent"
                          ToolTip="{Binding NotesAndTags}"
                          >
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="301" />
                            <!--  Tags  -->
                            <ColumnDefinition Width="161" />
                            <!--  Date  -->
                            <ColumnDefinition Width="101" />
                            <!--  Severity  -->
                            <ColumnDefinition Width="57" />
                            <!--  Rank  -->
                            <ColumnDefinition Width="25" />
                            <!--  ↓  -->
                            <ColumnDefinition Width="25" />
                            <!--  ↑  -->
                            <ColumnDefinition Width="71" />
                            <!--  Kanban  -->
                            <ColumnDefinition Width="111" />
                            <!--  Timer  -->

                            <ColumnDefinition Width="*" />
                            <!--         <ColumnDefinition.MaxWidth> -->
                            <!--             <Binding ElementName="lbTodos" Path="ActualWidth"> -->
                            <!--                 <Binding Converter="{StaticResource SubtractFixedWidthConverter}" ConverterParameter="551" /> -->
                            <!--             </Binding> -->
                            <!--         </ColumnDefinition.MaxWidth> -->
                            <!--         <ColumnDefinition.MinWidth>300</ColumnDefinition.MinWidth> -->
                            <!--     </ColumnDefinition> -->
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                   Margin="4,0"
                                   Text="{Binding TagsSorted}"
                                   TextTrimming="CharacterEllipsis"
                                   />
                        <!--  ToolTip="{Binding NotesAndTags}"  -->
                        <TextBlock Grid.Column="1"
                                   Margin="4,0"
                                   Foreground="Red"
                                   Text="{Binding StartDateTime}"
                                   />
                        <TextBlock Grid.Column="2"
                                   Width="90" Height="30"
                                   Margin="4" HorizontalAlignment="Left" VerticalAlignment="Top"
                                   Background="{Binding Severity, Converter={StaticResource SeverityToBrushConverter}}"
                                   FontWeight="SemiBold" Foreground="White" TextAlignment="Center" ToolTip="Severity"
                                   >
                            <TextBlock.InputBindings>
                                <MouseBinding Command="{Binding DataContext.ChangeSeverityCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                              CommandParameter="{Binding}"
                                              Gesture="LeftClick"
                                              />
                            </TextBlock.InputBindings>
                        </TextBlock>
                        <Label Grid.Column="3"
                               Width="50"
                               Content="{Binding Rank}"
                               />
                        <Button Grid.Column="4"
                                Width="25" Height="30"
                                Command="{Binding DataContext.RankDownCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                CommandParameter="{Binding}"
                                Content="▼" FontSize="16" FontWeight="Bold"
                                />
                        <Button Grid.Column="5"
                                Width="25" Height="30"
                                Command="{Binding DataContext.RankUpCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                CommandParameter="{Binding}"
                                Content="▲" FontSize="16" FontWeight="Bold"
                                />
                        <Label Grid.Column="6"
                               Width="70"
                               HorizontalAlignment="Center"
                               Content="{Binding Kanban}"
                               />
                        <Label Grid.Column="7"
                               Width="110"
                               HorizontalAlignment="Center"
                               Background="{Binding IsTimerOn, Converter={StaticResource BoolToLimeBrushConverter}}"
                               Content="{Binding TimeTakenDisplay, UpdateSourceTrigger=PropertyChanged}"
                               Foreground="{Binding IsTimerOn, Converter={StaticResource BoolToTimerTextConverter}}"
                               >
                            <Label.InputBindings>
                                <MouseBinding Command="{Binding DataContext.ToggleTimerCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                              CommandParameter="{Binding}"
                                              Gesture="LeftClick"
                                              />
                            </Label.InputBindings>
                        </Label>
                        <TextBlock Grid.Column="8"
                                   Margin="8,0,4,0"
                                   Text="{Binding Todo}"
                                   TextTrimming="CharacterEllipsis"
                                   />
                        <!--  ToolTip="{Binding Todo}"  -->
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!--  New TODOItem Editor  -->
        <Grid Grid.Row="3" Grid.Column="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="270" />
            </Grid.ColumnDefinitions>
            <TextBox Grid.Column="0"
                     AcceptsReturn="True" Cursor="IBeam" KeyboardNavigation.TabIndex="1" ScrollViewer.VerticalScrollBarVisibility="Auto"
                     Text="{Binding NewTodoText}"
                     TextWrapping="Wrap"
                     />
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <!-- <RowDefinition Height="*" /> -->
                </Grid.RowDefinitions>
                <!--  <TextBlock Grid.Row="2"  -->
                <!--  FontWeight="Bold"  -->
                <!--  Foreground="Red"  -->
                <!--  Text="{Binding DebugCount, StringFormat='Items in view: {0}'}" />  -->
                <Button Grid.Column="0"
                        Width="Auto"
                        Background="{Binding NewTodoSeverityBrush}"
                        Command="{Binding CycleNewTodoSeverityCommand}"
                        Content="Severity" FontWeight="SemiBold" Foreground="White"
                        Style="{StaticResource SeverityButton}"
                        />
                <Button Grid.Row="1"
                        Width="Auto"
                        Margin="4,0" Padding="16,8"
                        BorderThickness="0"
                        Command="{Binding NewTodoAddCommand}"
                        Content="Add" KeyboardNavigation.TabIndex="3"
                        />
            </Grid>
        </Grid>

        <!--  Items NotesPanel  -->
        <local:ItemNotesPanel x:Name="itemNotesPanel"
                              Grid.Row="0" Grid.RowSpan="4" Grid.Column="1"
                              NotesPanelCompleteRequested="NotesPanelCompleteRequested" NotesPanelEditTagsRequested="NotesPanelEditTagsRequested"
                              SelectedTodoItem="{Binding SelectedItem, ElementName=lbTodos, Mode=OneWay}"
                              />
    </Grid>
</UserControl>